'use strict';

var fs   = require('fs'),
    path = require('path');

var cache;

/**
 * Perform <code>path.relative()</code> but try to detect and correct sym-linked node modules.
 * @param {string} from The base path
 * @param {string} to The full path
 */
function enhancedRelative(from, to) {

  // relative path
  var relative = path.relative(from, to);

  // trailing is the relative path portion without any '../'
  var trailing = relative.replace(/^\.{2}[\\\/]/, ''),
      leading  = to.replace(trailing, '');

  // within project is what we want
  var isInProject = (relative === trailing);
  if (isInProject) {
    return relative;
  }
  // otherwise look at symbolic linked modules
  else {
    var splitTrailing = trailing.split(/[\\\/]/);

    // ensure failures can retry with fresh cache
    for (var i = cache ? 2 : 1, foundPath = false; (i > 0) && !foundPath; i--) {

      // ensure cache
      cache = cache || indexLinkedModules(from);

      // take elements from the trailing path and append them the 